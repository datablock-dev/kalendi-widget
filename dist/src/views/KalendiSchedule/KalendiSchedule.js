import{__awaiter as e,__generator as t}from"../../../node_modules/tslib/tslib.es6.js";import r,{useState as a,useEffect as n}from"react";import o from"../../../node_modules/dayjs/dayjs.min.js";import c from"../../../node_modules/dayjs/plugin/isBetween.js";import l from"../../../node_modules/@mui/icons-material/KeyboardArrowLeft.js";import i from"../../../node_modules/@mui/icons-material/KeyboardArrowRight.js";import{fixTimezoneTimestamp as s,months as d,weekDays as m}from"../../utils/time.js";var u=Array.from({length:24}).map((function(e,t){var r=t<10?"0":"";return["".concat(r).concat(t,":00"),"".concat(r).concat(t,":15"),"".concat(r).concat(t,":30"),"".concat(r).concat(t,":45")]})).flat(1);function f(d){var m=d.backendRoute;d.data;var f=d.services,v=d.selectedUser,h=d.selectedService,b=d.setView,x=d.setSelectedDate;o.extend(c);var y=o(),g=a(0),w=g[0],E=g[1],k=a(null),_=k[0],Y=k[1],M=a(null),N=M[0],j=M[1],D=a(null),O=D[0],L=D[1],Z=a(null),S=Z[0],I=Z[1],A=f.find((function(e){return e.service_id===h}));if(!A)return r.createElement("span",null,"...");function C(r){return e(this,void 0,void 0,(function(){var e,a,n,o,c;return t(this,(function(t){switch(t.label){case 0:return t.trys.push([0,3,,4]),null,v&&r?(a="".concat(r[0].year,"-").concat(r[0].monthLeadingZero,"-").concat(r[0].dayOfMonthLeadingZero),n="".concat(r[4].year,"-").concat(r[4].monthLeadingZero,"-").concat(r[4].dayOfMonthLeadingZero),(e="".concat(m,"/public/availability/").concat(v,"/null/").concat(a,"/").concat(n))?[4,fetch(e,{method:"GET"})]:[2]):[2];case 1:return[4,t.sent().json()];case 2:return(o=t.sent()).availability?j(o.availability):j(!1),o.bookings.length>0&&I(o.bookings),o.events&&L(o.events),[3,4];case 3:return c=t.sent(),console.error(c),[3,4];case 4:return[2]}}))}))}function H(e){"right"===e&&w<10?E(w+1):"left"===e&&w>0&&E(w-1)}return n((function(){_?_&&w!==_[0].weekFromCurrentWeek&&(Y(p(y,w)),C(p(y,w))):Y(p(y,w)),null===N&&v&&_&&C(_)}),[y,w]),r.createElement("div",{className:"h-[100%] w-[100%]"},r.createElement("div",{className:"flex flex-row justify-between w-[100%] h-[40px] mb-[10px]"},r.createElement("div",{className:"flex flex-row items-center gap-[6px] rounded-[3px] data-[selectable=true]:hover:cursor-pointer data-[selectable=false]:hover:cursor-not-allowed border-[#787878] border-[1px] border-solid px-[12px]","data-selectable":w>0,onClick:function(){H("left")}},r.createElement(l,null)," Previous Week"),r.createElement("div",{className:"flex flex-row items-center gap-[6px] rounded-[3px] data-[selectable=true]:hover:cursor-pointer data-[selectable=false]:hover:cursor-not-allowed data-[selectable=true]:hover:bg-[#d4d4d4] border-[#787878] border-[1px] border-solid px-[12px]","data-selectable":w<10,onClick:function(){H("right")}},"Next Week ",r.createElement(i,null))),!_&&r.createElement("div",{className:"w-[100%] h-[100%] flex justify-center items-center"},r.createElement("div",{id:"outer"},r.createElement("div",{id:"middle"},r.createElement("div",{id:"inner"})))),r.createElement("div",{className:"w-[100%] h-[50px] grid week-grid overflow-y-auto"},_&&null!==N&&_.map((function(e){return r.createElement("div",{className:"w-[100%] h-[100%] min-h-[100%] flex flex-col odd:bg-[#c4c4c48a]",key:e.date.format("YYYY-MM-DD HH:mm:ss"),"data-date":e.date.format("YYYY-MM-DD")},r.createElement("div",{className:"flex flex-col items-center"},r.createElement("span",null,e.weekDayString.substring(0,3)),r.createElement("span",null,e.dayOfMonth)))}))),r.createElement("div",{className:"w-[100%] h-[calc(100%_-_100px)] grid week-grid overflow-y-auto relative"},_&&null!==N&&_.map((function(e,t){var a=function(e,t){var r=!0;return e.forEach((function(e,a){var n=t?t[Object.keys(t)[2*a]]:null,o=t?t[Object.keys(t)[2*a+1]]:null;n&&o&&(r=!1)})),r}(_,N),n=N?N[Object.keys(N)[2*t]]:null,c=N?N[Object.keys(N)[2*t+1]]:null,l=u,i=!1;if(e.date.isBefore(y,"day")&&(i=!0,l=[]),n?(l=l.filter((function(e){return e>=n}))).length>0&&c&&(l=l.filter((function(e){return e<c}))):l=[],A.service_time_block){var d=A.service_time_block/15;l=l.filter((function(e,t){return t%d==0}))}if(o().isSame(e.date,"day")&&(l=l.filter((function(e){var t=e.split(":").map((function(e){return parseInt(e)})),r=t[0],a=t[1];return o().get("hour")<r||o().get("hour")===r&&o().get("minute")<a?e:void 0}))),O){var m=o(e.date);O.forEach((function(e){var t=o(s(e.from_timestamp)),r=o(s(e.to_timestamp));r.diff(t,"hour")>24&&o(m).isBetween(t,r,"minute")&&(l=[])}))}if(S){var f=o(e.date);A.service_time_block,S.forEach((function(e){var t=e.from_timestamp;e.to_timestamp,o(s(t));var r=t.split("T"),a=r[0],n=r[1];a===f.format("YYYY-MM-DD")&&(l=l.filter((function(e){if(o().set("hour",parseInt(e.split(":")[0])).set("minute",parseInt(e.split(":")[1])),e!==n.substring(0,5))return e})))}))}return r.createElement("div",{className:"w-[100%] h-[100%] min-h-[100%] flex flex-col",key:e.date.format("YYYY-MM-DD HH:mm:ss"),"data-date":e.date.format("YYYY-MM-DD")},r.createElement("div",{className:"flex flex-col h-[100%] items-center gap-[10px] bg-[#fff] pt-[10px]"},l.length>0&&l.filter((function(e){return parseInt(e.substring(0,2))>=7})).map((function(t){return r.createElement("div",{className:"rounded-[3px] bg-[#fff] py-[4px] px-[4px] border-solid border-[#d4d4d4] border-[1px] hover:cursor-pointer hover:bg-[#e4e4e4]",key:e.weekDayString+t,onClick:function(){var r="".concat(e.year,"-").concat(e.monthLeadingZero,"-").concat(e.dayOfMonthLeadingZero," ").concat(t,":00");x(o(r)),b("date-selected")}},r.createElement("span",null,t))})),!a&&0===l.length&&!i&&r.createElement("div",null,r.createElement("span",{className:"text-wrap"},"No available slots")),a&&2===t&&!i&&r.createElement("div",{className:"bg-[#1890ff] text-[#fff] px-[12px] py-[8px] rounded-[3px] border-[1px] hover:cursor-pointer hover:brightness-80 absolute bottom-[50%]"},r.createElement("span",null,"Next available time")),i&&r.createElement("div",{className:"w-[calc(100%_-_2px)] h-[100%] bg-[repeating-linear-gradient(45deg,#606dbc,#606dbc_10px,#465298_10px,#465298_20px)] rounded-[3px]"})))}))))}function p(e,t){var r=o(e),a=r.day(),n=new Array,c=a>0?1-r.day():-6,l=r.add(c,"day").add(t,"week");return Array.from({length:5}).forEach((function(e,r){var a=l.add(r,"day");n.push({dayOfMonth:a.date(),dayOfMonthLeadingZero:a.date()>=10?"".concat(a.date()):"0".concat(a.date()),year:a.year(),month:a.month(),monthLeadingZero:a.month()+1>=10?"".concat(a.month()+1):"0".concat(a.month()+1),monthString:d[a.month()],daysInMonth:a.daysInMonth(),weekDay:a.day(),weekDayString:m[a.day()],date:a,weekFromCurrentWeek:t})})),n}export{f as KalendiSchedule};
